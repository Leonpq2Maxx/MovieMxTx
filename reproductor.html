<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Reproductor táctil móvil</title>
<style>
  :root{
    --bg:#000;
    --accent:#ff3b30;
    --muted:#bdbdbd;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,Arial;}
  .player-wrap{display:flex;flex-direction:column;min-height:100vh;align-items:center;justify-content:center;padding:8px;box-sizing:border-box;}
  .screen{
    position:relative;width:100%;max-width:960px;background:#000;border-radius:12px;overflow:hidden;
    box-shadow:0 8px 30px rgba(0,0,0,0.6);
  }
  video{width:100%;height:calc(100vw * 0.5625);max-height:70vh;background:#000;display:block;object-fit:contain;-webkit-user-select:none;user-select:none;}
  /* Simple overlay controls */
  .controls{
    position:absolute;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.6));
    display:flex;flex-direction:column;gap:8px;box-sizing:border-box;
  }
  .row{display:flex;align-items:center;gap:8px;}
  .btn{
    width:42px;height:42px;border-radius:8px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;
    cursor:pointer;touch-action:none;
  }
  .btn svg{width:20px;height:20px;fill:#fff}
  .title{flex:1;font-size:14px;color:var(--muted);padding-left:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .time{font-size:13px;color:var(--muted);min-width:64px;text-align:right;}
  .progress{
    width:100%;height:6px;background:rgba(255,255,255,0.08);border-radius:6px;position:relative;touch-action:none;
  }
  .progress > .bar{position:absolute;left:0;top:0;bottom:0;width:0;background:var(--accent);border-radius:6px;}
  .progress .thumb{position:absolute;right:0;top:50%;transform:translate(50%,-50%);width:14px;height:14px;border-radius:50%;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.6);display:none;}
  .progress.dragging .thumb{display:block;}
  .hidden{display:none !important;}
  .settings{display:flex;gap:6px;align-items:center;}
  .speed{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.06);font-size:13px;}
  .url-form{display:flex;gap:8px;padding:10px;background:transparent;}
  .url-form input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;font-size:14px;}
  .url-form button{padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:#000;font-weight:600}
  .small{font-size:12px;color:var(--muted);padding:8px;text-align:center}
  /* Gestures feedback */
  .gesture-hint{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.5);padding:10px 14px;border-radius:10px;font-size:16px;display:none}
  /* Make controls more tappable on mobile */
  @media (max-width:420px){
    .btn{width:48px;height:48px;border-radius:12px;}
    .time{min-width:54px}
  }
</style>
</head>
<body>
  <div class="player-wrap">
    <div class="screen" id="screen">
      <video id="video" playsinline webkit-playsinline preload="metadata"></video>

      <div class="gesture-hint" id="gestureHint"></div>

      <div class="controls" id="controls">
        <div class="row" style="align-items:center;">
          <div class="btn" id="playBtn" title="Play/Pause">
            <!-- icon will be swapped by JS -->
            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          </div>

          <div class="title" id="title">Reproductor móvil</div>

          <div class="settings">
            <div class="speed" id="speedBtn" title="Velocidad">1x</div>
            <div class="btn" id="fsBtn" title="Pantalla completa">
              <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7zM7 5h5V3H5v5h2zM14 5h5v5h-2V7h-3zM14 19v-2h3v-3h2v5z"/></svg>
            </div>
          </div>
        </div>

        <div class="progress" id="progress">
          <div class="bar" id="bar"></div>
          <div class="thumb" id="thumb"></div>
        </div>

        <div class="row" style="justify-content:space-between;">
          <div class="row" style="gap:6px;">
            <div class="btn" id="back10" title="-10s"><svg viewBox="0 0 24 24"><path d="M11 5v4L6 6v12l5-3v4l9-8z"/></svg></div>
            <div class="btn" id="forward10" title="+10s"><svg viewBox="0 0 24 24"><path d="M13 19v-4l5 3V6l-5 3V5l9 8z"/></svg></div>
          </div>
          <div class="row" style="gap:12px;">
            <div class="time" id="current">0:00</div>
            <div class="time" id="total">0:00</div>
          </div>
        </div>
      </div>
    </div>

    <form class="url-form" id="urlForm" onsubmit="return false;">
      <input id="urlInput" placeholder="Pega aquí el link .mp4 o .mkv (CORS permitido)" />
      <button id="loadBtn">Cargar</button>
    </form>

    <div class="small">
      Double-tap derecha/izquierda para +10s/-10s · desliza arriba/abajo para volumen · Si MKV no funciona, convertir a MP4 o servir con CORS configurado.
    </div>
  </div>

<script>
(() => {
  const video = document.getElementById('video');
  const playBtn = document.getElementById('playBtn');
  const speedBtn = document.getElementById('speedBtn');
  const fsBtn = document.getElementById('fsBtn');
  const bar = document.getElementById('bar');
  const progress = document.getElementById('progress');
  const thumb = document.getElementById('thumb');
  const currentEl = document.getElementById('current');
  const totalEl = document.getElementById('total');
  const urlInput = document.getElementById('urlInput');
  const loadBtn = document.getElementById('loadBtn');
  const gestureHint = document.getElementById('gestureHint');
  const screen = document.getElementById('screen');

  let lastTap = 0;
  let isDragging = false;
  let draggingStartX = 0;
  let startVolume = 1;
  let panMode = null; // 'seek' or 'volume'
  let speedOptions = [0.5, 0.75, 1, 1.25, 1.5, 2];
  let speedIndex = 2;

  // Helper: format time
  function fmt(t){
    if (!isFinite(t) || t <= 0) return '0:00';
    const s = Math.floor(t%60).toString().padStart(2,'0');
    const m = Math.floor(t/60);
    return m + ':' + s;
  }

  // Update controls
  function updateProgress(){
    const pct = (video.currentTime / (video.duration || 1)) * 100;
    bar.style.width = pct + '%';
    currentEl.textContent = fmt(video.currentTime);
    totalEl.textContent = fmt(video.duration || 0);
  }

  // Play / Pause toggle
  function togglePlay(){
    if (video.paused) video.play().catch(e => console.warn('play failed', e));
    else video.pause();
    updatePlayIcon();
  }
  function updatePlayIcon(){
    playBtn.innerHTML = video.paused
      ? '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>'
      : '<svg viewBox="0 0 24 24"><path d="M6 6h4v12H6zM14 6h4v12h-4z"/></svg>';
  }

  // Load URL from form
  function loadURL(url){
    if(!url) return;
    // show filename
    document.getElementById('title').textContent = url.split('/').pop().split('?')[0];
    // Reset
    video.pause();
    video.removeAttribute('src');
    video.src = url;
    video.load();
    video.play().catch(()=>{}); // try autoplay
    updatePlayIcon();
  }

  // Attach events
  playBtn.addEventListener('click', togglePlay);
  video.addEventListener('play', updatePlayIcon);
  video.addEventListener('pause', updatePlayIcon);
  video.addEventListener('timeupdate', updateProgress);
  video.addEventListener('loadedmetadata', updateProgress);
  video.addEventListener('ended', () => { updatePlayIcon(); });

  // Load button
  loadBtn.addEventListener('click', () => loadURL(urlInput.value.trim()));

  // Progress touch handling
  function posFromEvent(e){
    const rect = progress.getBoundingClientRect();
    const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
    return Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
  }
  progress.addEventListener('pointerdown', (ev) => {
    isDragging = true;
    progress.classList.add('dragging');
    progress.setPointerCapture(ev.pointerId);
    const p = posFromEvent(ev);
    video.currentTime = p * (video.duration || 1);
  });
  progress.addEventListener('pointermove', (ev) => {
    if(!isDragging) return;
    const p = posFromEvent(ev);
    video.currentTime = p * (video.duration || 1);
  });
  progress.addEventListener('pointerup', (ev) => {
    isDragging = false;
    progress.classList.remove('dragging');
    try{ progress.releasePointerCapture(ev.pointerId); }catch(e){}
  });

  // Double tap to seek
  screen.addEventListener('touchend', (ev) => {
    const now = Date.now();
    if (now - lastTap < 300){
      // double tap
      const touch = ev.changedTouches[0];
      const w = screen.clientWidth;
      if (touch.clientX < w * 0.4) {
        // left double tap -> -10s
        video.currentTime = Math.max(0, video.currentTime - 10);
        flashGesture('-10s');
      } else {
        // right double tap -> +10s
        video.currentTime = Math.min(video.duration || Infinity, video.currentTime + 10);
        flashGesture('+10s');
      }
      lastTap = 0;
    } else {
      // single tap -> toggle controls (or play/pause)
      setTimeout(() => {
        // if lastTap reset by double-tap, don't toggle
        if (Date.now() - lastTap < 350) return;
        togglePlay();
      }, 250);
      lastTap = now;
    }
  });

  // Swipe up/down to change volume; long horizontal pan to seek
  let startX=0,startY=0,tracking=false;
  screen.addEventListener('touchstart',(e)=> {
    if(e.touches.length>1) return;
    tracking = true;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    startVolume = video.volume;
    panMode = null;
  }, {passive:true});

  screen.addEventListener('touchmove',(e)=> {
    if(!tracking) return;
    const dx = e.touches[0].clientX - startX;
    const dy = e.touches[0].clientY - startY;
    if (!panMode){
      if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) panMode = 'seek';
      else if (Math.abs(dy) > 10) panMode = 'volume';
    }
    if(panMode === 'volume'){
      // vertical swipe: top -> increase, bottom -> decrease
      const h = screen.clientHeight;
      const delta = -dy / h; // -dy so up is positive
      let v = Math.min(1, Math.max(0, startVolume + delta));
      video.volume = v;
      flashGesture('Vol ' + Math.round(v*100) + '%');
    } else if (panMode === 'seek'){
      // horizontal swipe: seek proportionally
      const w = screen.clientWidth;
      const pct = dx / w;
      const deltaSec = pct * (video.duration || 60);
      let t = Math.min(video.duration || Infinity, Math.max(0, video.currentTime + deltaSec));
      video.currentTime = t;
      flashGesture(fmt(video.currentTime));
    }
  }, {passive:true});

  screen.addEventListener('touchend',(e)=> { tracking=false; panMode=null; });

  // small visual hint
  let hintTimer = null;
  function flashGesture(text){
    gestureHint.textContent = text;
    gestureHint.style.display = 'block';
    clearTimeout(hintTimer);
    hintTimer = setTimeout(()=> gestureHint.style.display='none',800);
  }

  // Back/forward buttons
  document.getElementById('back10').addEventListener('click', ()=> { video.currentTime = Math.max(0,video.currentTime - 10); flashGesture('-10s'); });
  document.getElementById('forward10').addEventListener('click', ()=> { video.currentTime = Math.min(video.duration||Infinity,video.currentTime + 10); flashGesture('+10s'); });

  // Speed change
  speedBtn.addEventListener('click', ()=> {
    speedIndex = (speedIndex + 1) % speedOptions.length;
    video.playbackRate = speedOptions[speedIndex];
    speedBtn.textContent = speedOptions[speedIndex] + 'x';
    flashGesture(speedOptions[speedIndex] + 'x');
  });

  // Fullscreen
  fsBtn.addEventListener('click', async () => {
    if (!document.fullscreenElement) {
      try { await screen.requestFullscreen(); }
      catch(e){ console.warn('fullscreen fail', e); }
    } else {
      try { await document.exitFullscreen(); } catch(e){}
    }
  });

  // Keyboard: space toggles (for desktop testing)
  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
    if (e.code === 'ArrowRight') video.currentTime += 10;
    if (e.code === 'ArrowLeft') video.currentTime -= 10;
  });

  // If video not playable (e.g., MKV not supported), show hint in console and small message
  video.addEventListener('error', (ev) => {
    console.warn('Video error', ev);
    flashGesture('Error al reproducir (comprueba formato/CORS)');
  });

  // Helper: quick default sample (opcional)
  // Puedes dejar una URL de prueba aquí si quieres que cargue automáticamente:
  // loadURL('https://www.example.com/pelicula.mp4');

  // Expose loadURL to global so devs can call from console
  window.loadURL = loadURL;

  // tiny utility: show total when metadata loaded
  video.addEventListener('loadedmetadata', ()=> { totalEl.textContent = fmt(video.duration || 0); });

  // OPTIONAL: Detect if the container is offline or CORS blocked
  // (Can't reliably detect CORS from JS but video.onerror often hints)
})();
</script>
</body>
</html>
