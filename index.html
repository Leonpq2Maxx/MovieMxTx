
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MovieTx</title>
<style>
  :root{
    --bg:#050505;
    --card:#141414;
    --accent:#e50914;
    --muted:#bfbfbf;
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:#fff;background:var(--bg)}
  /* Loading screen */
  #splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:linear-gradient(180deg,#000 0%, #050505 100%);z-index:99999}
  .logo{font-weight:900;color:var(--accent);font-size:42px;letter-spacing:2px;opacity:0;animation:logoIn 900ms ease forwards}
  .loader{margin-top:18px;height:8px;width:160px;border-radius:6px;overflow:hidden;background:rgba(255,255,255,0.04);position:relative}
  .loader:before{content:'';position:absolute;left:-40%;top:0;height:100%;width:40%;background:linear-gradient(90deg,transparent,rgba(229,9,20,0.65),transparent);animation:shine 1.2s linear infinite}
  @keyframes shine{0%{left:-40%}100%{left:140%}}
  @keyframes logoIn{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:none}}

  /* Page header */
  header{height:68px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:rgba(0,0,0,0.2);backdrop-filter:blur(6px);position:fixed;inset:auto 0 0 0;z-index:10}
  .brand{font-weight:900;color:var(--accent);font-size:20px}
  .right-controls{display:flex;align-items:center;gap:12px}

  /* avatar button */
  .avatar-btn{width:40px;height:40px;border-radius:6px;overflow:hidden;display:inline-block;background:#222;cursor:pointer;border:2px solid transparent}
  .avatar-img{width:100%;height:100%;object-fit:cover;display:block}

  /* main content */
  main{padding:110px 20px 60px;max-width:1100px;margin:0 auto}
  .hero{display:flex;gap:20px;align-items:center}
  .poster{width:320px;height:180px;background:#222;border-radius:8px;flex-shrink:0}
  .meta{flex:1}
  .btn{background:var(--accent);border:none;padding:12px 16px;border-radius:8px;color:#fff;font-weight:700;cursor:pointer}

  /* Modal backdrop */
  .backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);z-index:9998;transition:opacity .25s ease}
  .backdrop.active{display:flex;opacity:1}

  /* Modal box */
  .modal{width:92%;max-width:760px;background:var(--card);border-radius:10px;padding:18px;box-shadow:0 30px 80px rgba(0,0,0,0.6);transform:scale(.98);opacity:0;transition:all .25s ease}
  .backdrop.active .modal{transform:none;opacity:1}
  .modal-grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .left{padding:12px}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:8px;cursor:pointer;background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
  .tab.active{background:rgba(255,255,255,0.03);color:#fff;border-color:rgba(229,9,20,0.15)}

  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#0d0d0d;color:#fff;margin-bottom:12px}

  .small{font-size:13px;color:var(--muted)}

  .profile-box{text-align:center;padding:10px}
  .profile-box img{width:120px;height:120px;border-radius:10px;object-fit:cover;border:3px solid rgba(255,255,255,0.04)}

  .close-x{position:absolute;top:10px;right:12px;background:none;border:none;color:rgba(229,9,20,0.85);font-size:16px;cursor:pointer;padding:6px;border-radius:6px}
  .close-x:hover{color:var(--accent)}

  /* responsive */
  @media(max-width:800px){ .modal-grid{grid-template-columns:1fr} .left{order:2} .profile-box{order:1} }
</style>
</head>
<body>

<!-- Splash loading screen -->
<div id="splash" aria-hidden="false">
  <div class="logo">MovieTx</div>
  <div class="loader" aria-hidden="true"></div>
</div>

<header>
  <div class="brand">MovieTx</div>
  <div class="right-controls">
    <button id="profileBtn" class="avatar-btn" title="Perfil" style="display:none">
      <img id="avatarImg" class="avatar-img" src="" alt="avatar">
    </button>
    <button id="loginBtn" class="btn" style="display:none">Iniciar / Registrarse</button>
  </div>
</header>

<main>
  <section class="hero">
    <div class="poster"></div>
    <div class="meta">
      <h1>Bienvenido a MovieTx</h1>
      <p class="small">Tu reproductor personal. Revisa tu suscripción, reanuda episodios o reproduce películas.</p>
      <div style="margin-top:18px">
        <button id="openModalSubscribe" class="btn">Suscribirme 30 días</button>
      </div>
      <div id="subStatus" style="margin-top:12px;color:var(--muted)"></div>
    </div>
  </section>
</main>

<!-- Modal backdrop -->
<div id="modalBackdrop" class="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <button class="close-x" id="closeModal" aria-label="Cerrar">✖</button>
    <div class="modal-grid">
      <div class="left">
        <div class="tabs">
          <div class="tab active" data-tab="login">Iniciar sesión</div>
          <div class="tab" data-tab="register">Registrarse</div>
        </div>

        <!-- login form -->
        <div id="loginForm">
          <label>Email</label>
          <input id="loginEmail" type="email" autocomplete="username">
          <label>Contraseña</label>
          <input id="loginPassword" type="password" autocomplete="current-password">
          <button id="doLogin" class="btn" style="width:100%">Iniciar sesión</button>
          <div class="small" style="margin-top:10px">¿No tenés cuenta? Cambiá a Registrarse.</div>
          <div id="loginMsg" style="color:#f66;margin-top:8px"></div>
        </div>

        <!-- register form -->
        <div id="registerForm" style="display:none">
          <label>Email</label>
          <input id="regEmail" type="email">
          <label>Contraseña</label>
          <input id="regPassword" type="password">
          <label>Género</label>
          <select id="regGender">
            <option value="male">Masculino</option>
            <option value="female">Femenino</option>
            <option value="other">Otro</option>
          </select>
          <label>Imagen de perfil (opcional)</label>
          <input id="regAvatarFile" type="file" accept="image/*">
          <button id="doRegister" class="btn" style="width:100%">Registrarse</button>
          <div id="regMsg" style="color:#f66;margin-top:8px"></div>
        </div>

      </div>

      <div class="profile-box">
        <img id="previewAvatar" src="" alt="Avatar">
        <div style="margin-top:12px">
          <div id="profileName" class="small">Usuario</div>
          <div id="profileSub" class="small" style="margin-top:6px">Sin suscripción</div>
          <div style="margin-top:10px">
            <button id="doSubscribeInside" class="btn">Suscribirme 30 días</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// small helper API call that includes credentials
async function api(path, opts={}) {
  opts.credentials = 'include';
  return fetch(path, opts).then(r => r.json()).catch(e => ({ error: e.message }));
}

// Avatar helpers: generate default avatar using ui-avatars based on gender
function generateAvatarUrl(name, gender) {
  let bg = '444444';
  if (gender === 'male') bg = '1f3bff';
  if (gender === 'female') bg = 'ff3fb3';
  if (gender === 'other') bg = '666666';
  const initials = encodeURIComponent((name||'User').split(' ').map(p=>p[0]||'').join('').slice(0,2).toUpperCase());
  return `https://ui-avatars.com/api/?name=${initials}&background=${bg}&color=ffffff&rounded=true&size=256`;
}

// local avatar storage per user id (fallback until server upload endpoint exists)
function setLocalAvatarForUser(userId, dataUrl) {
  if (!userId) return;
  localStorage.setItem('movietx_avatar_' + userId, dataUrl);
}
function getLocalAvatarForUser(userId) {
  return localStorage.getItem('movietx_avatar_' + userId) || null;
}
function removeLocalAvatarForUser(userId) {
  localStorage.removeItem('movietx_avatar_' + userId);
}

// elements
const splash = document.getElementById('splash');
const backdrop = document.getElementById('modalBackdrop');
const loginBtn = document.getElementById('loginBtn');
const profileBtn = document.getElementById('profileBtn');
const avatarImg = document.getElementById('avatarImg');
const previewAvatar = document.getElementById('previewAvatar');
const profileName = document.getElementById('profileName');
const profileSub = document.getElementById('profileSub');
const subStatus = document.getElementById('subStatus');
const openModalSubscribe = document.getElementById('openModalSubscribe');

let currentUser = null;
let subscriptionActive = false;

// show splash minimum time and also wait for initial check
async function init() {
  const minDelay = new Promise(r => setTimeout(r, 2000)); // at least 2s
  // begin backend checks in parallel
  const userPromise = api('/api/user');
  const subPromise = api('/api/subscription-status').catch(()=>({active:false}));

  const [userRes, subRes] = await Promise.all([userPromise, subPromise]);
  if (userRes && userRes.user) {
    currentUser = userRes.user;
    // get subscription status only if user exists
    const s = await api('/api/subscription-status');
    subscriptionActive = s.active;
    if (s.expiresAt) profileSub.textContent = s.active ? ('Vence: ' + s.expiresAt) : 'Sin suscripción';
  } else {
    currentUser = null;
    subscriptionActive = false;
  }

  // ensure splash visible at least 2s
  await minDelay;

  // hide splash and setup UI
  splash.style.display = 'none';
  setupUI();
  // if not logged in, show modal automatically (backdrop)
  if (!currentUser) {
    openAuthModal();
  }
}

function setupUI() {
  if (currentUser) {
    // show profile button
    profileBtn.style.display = 'inline-block';
    loginBtn.style.display = 'none';
    // name
    profileName.textContent = currentUser.email;
    // avatar: check localStorage first
    const localAvatar = getLocalAvatarForUser(currentUser.id);
    if (localAvatar) {
      avatarImg.src = localAvatar;
      previewAvatar.src = localAvatar;
    } else {
      const gen = generateAvatarUrl(currentUser.email, 'other');
      avatarImg.src = gen;
      previewAvatar.src = gen;
    }
    profileBtn.addEventListener('click', ()=> {
      openAuthModal();
    });
    subStatus.textContent = subscriptionActive ? 'Suscripción activa' : 'No suscripto';
    document.getElementById('openModalSubscribe').style.display = subscriptionActive ? 'none' : 'inline-block';
  } else {
    profileBtn.style.display = 'none';
    loginBtn.style.display = 'inline-block';
    loginBtn.addEventListener('click', openAuthModal);
    subStatus.textContent = 'Inicia sesión para ver estado de suscripción';
  }
}

// Modal controls
const closeModal = document.getElementById('closeModal');
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t => t.addEventListener('click', ()=>{
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const tab = t.dataset.tab;
  document.getElementById('loginForm').style.display = tab==='login'? 'block':'none';
  document.getElementById('registerForm').style.display = tab==='register'? 'block':'none';
}));

function openAuthModal() {
  if (currentUser) {
    profileName.textContent = currentUser.email;
    api('/api/subscription-status').then(s => {
      profileSub.textContent = s.active ? ('Vence: ' + s.expiresAt) : 'Sin suscripción';
    });
  } else {
    profileName.textContent = 'Invitado';
    profileSub.textContent = 'Sin sesión';
  }
  backdrop.classList.add('active');
  backdrop.setAttribute('aria-hidden', 'false');
}

function closeAuthModal() {
  backdrop.classList.remove('active');
  backdrop.setAttribute('aria-hidden', 'true');
}

// login/register actions
document.getElementById('doLogin').addEventListener('click', async ()=>{
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  const res = await api('/api/login', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
  if (res.ok) {
    currentUser = res.user;
    subscriptionActive = (await api('/api/subscription-status')).active;
    closeAuthModal();
    setupUI();
  } else {
    document.getElementById('loginMsg').textContent = res.error || 'Error al iniciar sesión';
  }
});

document.getElementById('doRegister').addEventListener('click', async ()=>{
  const email = document.getElementById('regEmail').value;
  const password = document.getElementById('regPassword').value;
  const gender = document.getElementById('regGender').value;
  const file = document.getElementById('regAvatarFile').files[0];
  const body = { email, password };
  const res = await api('/api/register', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if (res.ok) {
    currentUser = res.user;
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        setLocalAvatarForUser(currentUser.id, e.target.result);
        previewAvatar.src = e.target.result;
        avatarImg.src = e.target.result;
      };
      reader.readAsDataURL(file);
    } else {
      const url = generateAvatarUrl(currentUser.email, gender);
      previewAvatar.src = url;
      avatarImg.src = url;
      setLocalAvatarForUser(currentUser.id, url);
    }
    subscriptionActive = false;
    closeAuthModal();
    setupUI();
  } else {
    document.getElementById('regMsg').textContent = res.error || 'Error al registrarse';
  }
});

// subscribe flows (both inside modal and main)
document.getElementById('doSubscribeInside').addEventListener('click', async ()=>{
  if (!currentUser) return alert('Inicia sesión primero');
  const resp = await api('/api/create_preference', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ planDays: 30 }) });
  if (resp.init_point) window.location.href = resp.init_point;
  else alert('No se pudo iniciar el pago');
});
document.getElementById('openModalSubscribe').addEventListener('click', async ()=>{
  if (!currentUser) { openAuthModal(); tabs[1].click(); return; }
  const resp = await api('/api/create_preference', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ planDays: 30 }) });
  if (resp.init_point) window.location.href = resp.init_point;
  else alert('No se pudo iniciar el pago');
});

// logout destroys session and remove local avatar
async function doLogout() {
  if (!currentUser) return;
  removeLocalAvatarForUser(currentUser.id);
  await api('/api/logout', { method: 'POST' });
  currentUser = null;
  subscriptionActive = false;
  window.location.reload();
}

// hook close modal button
closeModal.addEventListener('click', closeAuthModal);

// allow clicking outside modal to close
backdrop.addEventListener('click', (e)=>{ if (e.target === backdrop) closeAuthModal(); });

// profile button actions: small menu
profileBtn.addEventListener('click', async (e)=>{
  if (!currentUser) { openAuthModal(); return; }
  const action = prompt('Opciones: 1=Ver perfil, 2=Cambiar avatar, 3=Cerrar sesión\nEscribe 1,2 o 3');
  if (action === '1') {
    alert('Usuario: ' + currentUser.email);
  } else if (action === '2') {
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'image/*';
    inp.onchange = function(){ 
      const f = inp.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        setLocalAvatarForUser(currentUser.id, ev.target.result);
        avatarImg.src = ev.target.result;
        previewAvatar.src = ev.target.result;
        alert('Avatar actualizado (local)');
      };
      reader.readAsDataURL(f);
    };
    inp.click();
  } else if (action === '3') {
    if (confirm('Cerrar sesión?')) doLogout();
  }
});

// on load
init();
</script>
</body>
</html>
