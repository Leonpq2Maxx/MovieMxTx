<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Historial</title>

<link rel="stylesheet"
 href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css">

<style>
/* ========= GENERAL ========= */
body {
  margin: 0;
  background: #121212;
  font-family: Arial, sans-serif;
  color: #fff;
}

header {
  background: #1e1e1e;
  padding: 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 1.2rem;
}

header i {
  cursor: pointer;
  font-size: 1.3rem;
}

#header-title.selection-active::after {
  content: " — Seleccionando";
  font-size: 0.9rem;
  color: #00ffc3;
  margin-left: 5px;
}

/* ========= GRID ========= */
#historial-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  padding: 15px;
  gap: 15px;
}

.item {
  background: #1a1a1a;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
  transition: transform 0.15s;
}

.item img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 10px;
}

.item-title {
  text-align: center;
  padding: 8px;
  font-size: 0.85rem;
  line-height: 1.1rem;
}

/* ========= PROGRESO ========= */
.capitulo {
  background: rgba(0,0,0,0.7);
  color: #00ffae;
  padding: 4px 8px;
  position: absolute;
  bottom: 10px;
  left: 10px;
  border-radius: 5px;
  font-size: 0.75rem;
}

.etiqueta {
  position: absolute;
  top: 10px;
  left: 10px;
  background: #e91e63;
  color: white;
  padding: 3px 8px;
  border-radius: 5px;
  font-size: 0.7rem;
}

/* ========= BOTÓN ELIMINAR INDIVIDUAL ========= */
.delete-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 26px;
  height: 26px;
  background: rgba(255,0,0,0.8);
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 0.8rem;
  cursor: pointer;
  z-index: 20;
}

.selection-mode .delete-btn {
  display: none;
}

/* ========= MODO SELECCIÓN ========= */
.item.selected {
  outline: 3px solid #00eaff;
  transform: scale(0.97);
}

.select-overlay {
  position: absolute;
  inset: 8px;
  display: flex;
  justify-content: flex-end;
  pointer-events: none;
}

.check {
  display: none;
  background: rgba(0,0,0,0.6);
  color: #00ffae;
  padding: 6px;
  border-radius: 50%;
  margin: 5px;
  pointer-events: none;
}

.item.selected .check {
  display: block;
}

/* ========= MENSAJE FLOTANTE ========= */
#mensaje-confirmacion {
  display: none;
  position: fixed;
  bottom: 25px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.85);
  padding: 12px 20px;
  border-radius: 10px;
  font-size: 1rem;
  z-index: 9999;
  transition: opacity 0.4s ease;
}

/* ========= RESPONSIVE ========= */
@media (max-width: 768px) {
  #historial-container {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 480px) {
  #historial-container {
    grid-template-columns: repeat(2, 1fr);
  }
}
</style>
</head>

<body>

<header>
  <i class="fas fa-arrow-left" onclick="history.back()"></i>
  <span id="header-title">Historial</span>
  <i id="trash-multi" class="fas fa-trash" 
     style="display:none;" onclick="confirmarEliminarSeleccionados()"></i>
  <i id="trash-all" class="fas fa-trash-alt" onclick="limpiarHistorial()"></i>
</header>

<h2 style="padding:15px;">Vistos recientemente</h2>

<div id="historial-container"></div>

<div id="mensaje-confirmacion"></div>

<!-- Confirmación -->
<div id="modal-confirmacion" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.7);
  align-items:center; justify-content:center; z-index:999999;">
  <div style="background:#1e1e1e;padding:20px;border-radius:14px;text-align:center;">
    <p id="modal-mensaje" style="font-size:1rem;margin-bottom:15px;"></p>
    <button onclick="confirmarEliminar()" 
      style="padding:8px 20px;border:none;border-radius:6px;background:#e91e63;color:white;cursor:pointer;">Eliminar</button>
    <button onclick="cerrarModal()" 
      style="padding:8px 20px;border:none;border-radius:6px;margin-left:10px;background:#333;color:white;cursor:pointer;">Cancelar</button>
  </div>
</div>

<script>
/* ==========================================================
   VARIABLES
========================================================== */
let historial = JSON.parse(localStorage.getItem("historial_usuarios") || "[]");
let seleccionados = new Set();
let seleccionMode = false;
let pendienteEliminar = null;
let longPressTimers = new Map();

/* ==========================================================
   MOSTRAR MENSAJE FLOTANTE
========================================================== */
function mostrarMensaje(msg) {
  let box = document.getElementById("mensaje-confirmacion");
  box.textContent = msg;
  box.style.display = "block";
  box.style.opacity = "1";

  setTimeout(() => {
    box.style.opacity = "0";
    setTimeout(() => (box.style.display = "none"), 400);
  }, 1800);
}

/* ==========================================================
   RENDERIZAR HISTORIAL
========================================================== */
function renderHistorial() {
  const cont = document.getElementById("historial-container");
  cont.innerHTML = "";

  historial.sort((a, b)=> (b.timestamp || 0) - (a.timestamp || 0));

  historial.forEach((item, index) => {
    let card = document.createElement("div");
    card.className = "item";
    if (seleccionados.has(index)) card.classList.add("selected");

    card.innerHTML = `
      <div style="position:relative;">
        <img src="${item.imagen}">
        <div class="capitulo">${item.progreso}</div>
        <div class="etiqueta">${item.tipo === "serie" ? "Serie" : "Película"}</div>
        <div class="select-overlay"><div class="check">✓</div></div>
      </div>
      <div class="item-title">${item.titulo}</div>

      <button class="delete-btn" onclick="eliminarItem(${index})">×</button>
    `;

    // === LONG PRESS ===
    card.addEventListener("touchstart", () => {
      const t = setTimeout(() => {
        if (!seleccionMode) entrarModoSeleccion();
        toggleSeleccion(index);
      }, 600);
      longPressTimers.set(index, t);
    });

    card.addEventListener("touchend", () => {
      if (longPressTimers.get(index)) {
        clearTimeout(longPressTimers.get(index));
        longPressTimers.delete(index);

        if (seleccionMode) toggleSeleccion(index);
        else window.location.href = item.archivo;
      }
    });

    cont.appendChild(card);
  });
}

/* ==========================================================
   SELECCIÓN MÚLTIPLE
========================================================== */
function entrarModoSeleccion() {
  seleccionMode = true;
  document.body.classList.add("selection-mode");
  document.getElementById("trash-multi").style.display = "inline-block";
  document.getElementById("trash-all").style.display = "none";
  document.getElementById("header-title").classList.add("selection-active");
}

function salirModoSeleccion() {
  seleccionMode = false;
  seleccionados.clear();
  document.body.classList.remove("selection-mode");
  document.getElementById("trash-multi").style.display = "none";
  document.getElementById("trash-all").style.display = "inline-block";
  document.getElementById("header-title").classList.remove("selection-active");
  renderHistorial();
}

function toggleSeleccion(index) {
  if (seleccionados.has(index)) seleccionados.delete(index);
  else seleccionados.add(index);
  renderHistorial();
}

/* ==========================================================
   ELIMINAR INDIVIDUAL
========================================================== */
function eliminarItem(index) {
  pendienteEliminar = { type: "one", index };
  document.getElementById("modal-mensaje").innerText =
    `¿Eliminar "${historial[index].titulo}" del historial?`;
  abrirModal();
}

/* ==========================================================
   ELIMINAR SELECCIONADOS
========================================================== */
function confirmarEliminarSeleccionados() {
  if (seleccionados.size === 0) return;
  pendienteEliminar = { type: "multi", items: new Set(seleccionados) };
  document.getElementById("modal-mensaje").innerText =
    `Eliminar ${seleccionados.size} elementos seleccionados?`;
  abrirModal();
}

/* ==========================================================
   ELIMINAR TODO
========================================================== */
function limpiarHistorial() {
  pendienteEliminar = { type: "all" };
  document.getElementById("modal-mensaje").innerText =
    "¿Eliminar TODO el historial?";
  abrirModal();
}

/* ==========================================================
   MODAL
========================================================== */
function abrirModal() {
  document.getElementById("modal-confirmacion").style.display = "flex";
}

function cerrarModal() {
  document.getElementById("modal-confirmacion").style.display = "none";
  pendienteEliminar = null;
}

function confirmarEliminar() {
  if (!pendienteEliminar) return;

  if (pendienteEliminar.type === "one") {
    historial.splice(pendienteEliminar.index, 1);
  }

  if (pendienteEliminar.type === "multi") {
    const arr = Array.from(pendienteEliminar.items).sort((a,b)=>b-a);
    for (let i of arr) historial.splice(i, 1);
    salirModoSeleccion();
  }

  if (pendienteEliminar.type === "all") {
    historial = [];
  }

  localStorage.setItem("historial_usuarios", JSON.stringify(historial));
  renderHistorial();
  cerrarModal();
  mostrarMensaje("Cambios aplicados.");
}

/* ==========================================================
   INICIAL
========================================================== */
renderHistorial();
</script>

</body>
</html>
