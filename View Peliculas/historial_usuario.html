
<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Historial</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto&amp;display=swap" rel="stylesheet"/>
<link href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" rel="stylesheet"/>
<style>
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background-color: #121212;
      color: white;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      background-color: #1e1e1e;
      font-size: 1.2rem;
    }
    header i {
      font-size: 1.2rem;
      cursor: pointer;
    }
    h2 {
      padding: 15px;
      font-size: 1.2rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      padding: 0 15px 30px;
    }
    .item {
      background-color: #1a1a1a;
      border-radius: 10px;
      overflow: hidden;
      font-size: 0.6rem;
      position: relative;
    }
    .item img {
      width: 100%;
      height: 180px; /* o 240px */ /*ACA ES EL LARGO DE LA IMAGEN*/
      object-fit: cover;
      border-radius: 8px;
    }
    .item .etiqueta {
      position: absolute;
      top: 8px;
      left: 8px;
      background: #e91e63;
      color: white;
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .capitulo {
      background: rgba(0, 0, 0, 0.7);
      color: #00ffae;
      padding: 3px 6px;
      font-size: 0.75rem;
      position: absolute;
      bottom: 35px;
      left: 5px;
      border-radius: 5px;
    }
    .item-title {
      padding: 8px;
      text-align: center;
    }
    .delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(255, 0, 0, 0.8);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 0.8rem;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    #mensaje-confirmacion {
      display: none;
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      z-index: 9999;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
      transition: opacity 0.5s ease;
    }
  
@media screen and (orientation: landscape) {
  .grid {
    grid-template-columns: repeat(4, 1fr);
  }
  .item img {
    height: 120px !important;
    object-fit: contain !important;
    background-color: #000;
    width: 100%;
  }
  .item {
    padding-bottom: 5px;
  }
}
</style>
</head>
<body>

  <!-- üî¥ Pantalla de carga personalizada MovieTx (versi√≥n ne√≥n) -->
<div id="loader-screen">
  <div class="loader-content">
    <div class="loader-circle">
      <img src="../Logo Poster MovieTx PNG/Logo MovieTx.png" alt="Logo MovieTx" class="loader-logo">
    </div>
    <h1 class="loader-title">MovieTx</h1>
    <p class="loader-sub">Cargando<span class="loading-dots"></span></p>
    <p class="loader-msg">Por favor, espere</p>
  </div>
</div>

<style>
#loader-screen {
  position: fixed;
  inset: 0;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 10000;
  transition: opacity 1s ease, visibility 1s ease;
}
#loader-screen.hidden {
  opacity: 0;
  visibility: hidden;
}
.loader-content {
  text-align: center;
}
.loader-circle {
  width: 180px;
  height: 180px;
  border-radius: 50%;
  border: 6px solid transparent;
  border-top: 6px solid #00aaff;
  border-bottom: 6px solid #ff007f;
  animation: spin 2s linear infinite;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
  box-shadow: 0 0 30px rgba(255, 0, 128, 0.5);
}
.loader-logo {
  width: 100px;
  height: auto;
}
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
.loader-title {
  font-size: 2.5rem;
  color: #fff;
  text-shadow: 0 0 10px #ff4da6, 0 0 20px #ff1a8c, 0 0 40px #ff007f;
  font-weight: bold;
  margin-bottom: 10px;
  letter-spacing: 2px;
}
.loader-sub {
  font-size: 1.2rem;
  color: #ccc;
}
.loading-dots::after {
  content: '';
  animation: dotPulse 1.5s infinite steps(4);
}
@keyframes dotPulse {
  0% { content: ''; }
  25% { content: '.'; }
  50% { content: '..'; }
  75% { content: '...'; }
  100% { content: ''; }
}
.loader-msg {
  font-size: 1rem;
  color: #888;
  margin-top: 10px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const loader = document.getElementById('loader-screen');
  const continueModal = document.getElementById('continue-modal');
  if (continueModal) continueModal.style.display = 'none'; // Ocultamos modal al inicio

  setTimeout(() => {
    loader.classList.add('hidden');
    setTimeout(() => {
      if (continueModal) continueModal.style.display = ''; // Mostrar despu√©s del fade
    }, 1200);
  }, 5000); // 10 segundos
});
</script>
<!-- üî¥ Fin pantalla de carga ne√≥n -->

<!-- Reemplaza tu header por este (o integra los cambios: agregado boton trash-multi) -->
<header>
  <i class="fas fa-arrow-left" onclick="history.back()"></i>
  <span id="header-title">Historial</span>
  <!-- bot√≥n para eliminar seleccionados (aparece solo en modo selecci√≥n) -->
  <i id="trash-multi" class="fas fa-trash-alt" style="display:none; cursor:pointer;" onclick="confirmarEliminarSeleccionados()"></i>
  <!-- bot√≥n original para limpiar todo -->
  <i id="trash-all" class="fas fa-trash-alt" onclick="limpiarHistorial()"></i>
</header>

<!-- Agrega estos estilos CSS a tu <style> principal -->
<style>
/* estado de tarjeta seleccionada */
.item.selected {
  outline: 3px solid rgba(0, 170, 255, 0.9);
  transform: scale(0.995);
}
.item .select-overlay {
  position: absolute;
  inset: 6px;
  border-radius: 8px;
  display:flex;
  align-items:flex-start;
  justify-content:flex-end;
  pointer-events: none;
}
.item .select-overlay .check {
  pointer-events: auto;
  background: rgba(0,0,0,0.6);
  color: #00ffae;
  padding: 6px;
  border-radius: 50%;
  margin: 8px;
  font-size: 0.9rem;
  display: none;
  border: 1px solid rgba(0,255,170,0.2);
}
.item.selected .select-overlay .check {
  display: block;
}

/* ocultar bot√≥n eliminar por tarjeta cuando est√° en modo selecci√≥n (opcional) */
.item .delete-btn.hide-when-select {
  display: inline-block;
}
.selection-mode .item .delete-btn.hide-when-select {
  display: none;
}

/* indicador modo selecci√≥n en header */
#header-title.selection-active::after {
  content: " ‚Äî Seleccionando";
  font-size: 0.85rem;
  color: #00ffae;
  margin-left: 8px;
}

/* peque√±o ajuste visual para toque largo */
.item.touching {
  opacity: 0.9;
  transform: translateY(1px);
}
</style>

<!-- Reemplaza o a√±ade este script (remplaza el renderHistorial y a√±ade la l√≥gica de selecci√≥n) -->
<script>
  // Variables nuevas
  let historial = JSON.parse(localStorage.getItem('historial_usuarios') || '[]');
  const LIMITE_HISTORIAL = 21;
  let seleccionados = new Set();
  let selectionMode = false;
  let longPressTimers = new Map(); // index -> timerId
  const LONG_PRESS_DURATION = 600; // ms, puedes ajustar

  // ordenar y recortar (igual que antes)
  historial.sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
  while (historial.length > LIMITE_HISTORIAL) historial.pop();
  localStorage.setItem('historial_usuarios', JSON.stringify(historial));

  // ---------- utilidades selecci√≥n ----------
  function entrarModoSeleccion() {
    selectionMode = true;
    document.body.classList.add('selection-mode');
    document.getElementById('trash-multi').style.display = 'inline-block';
    document.getElementById('trash-all').style.display = 'none';
    document.getElementById('header-title').classList.add('selection-active');
    renderHistorial(); // para actualizar botones/estados visuales
  }
  function salirModoSeleccion() {
    selectionMode = false;
    seleccionados.clear();
    document.body.classList.remove('selection-mode');
    document.getElementById('trash-multi').style.display = 'none';
    document.getElementById('trash-all').style.display = 'inline-block';
    document.getElementById('header-title').classList.remove('selection-active');
    renderHistorial();
  }
  function toggleSeleccion(index) {
    if (seleccionados.has(index)) seleccionados.delete(index);
    else seleccionados.add(index);
    // si no queda ninguno, salimos del modo selecci√≥n autom√°ticamente
    if (seleccionados.size === 0) {
      // opcional: si quieres mantener el modo hasta que el usuario cancele, comenta la siguiente l√≠nea
      // salirModoSeleccion();
    }
    renderHistorial();
  }

  // ---------- eliminar seleccionados ----------
  function confirmarEliminarSeleccionados() {
    if (seleccionados.size === 0) return;
    const titulos = Array.from(seleccionados).map(i => historial[i]?.titulo).filter(Boolean);
    pendienteEliminarIndex = 'multiple';
    pendienteEliminarTitulo = `(${titulos.length}) elementos seleccionados`;
    document.getElementById('modal-mensaje').textContent = `¬øEliminar ${titulos.length} elementos seleccionados?`;
    document.getElementById('modal-confirmacion').style.display = 'flex';
  }

  // modifica el handler de confirmar para soportar 'multiple'
  document.getElementById('btn-confirmar').onclick = () => {
    if (pendienteEliminarIndex === 'all') {
      localStorage.removeItem('historial_usuarios');
      historial = [];
      renderHistorial();
      mostrarMensaje('üßπ Historial eliminado');
    } else if (pendienteEliminarIndex === 'multiple') {
      // eliminamos √≠ndices seleccionados (orden descendente para no desordenar)
      const indices = Array.from(seleccionados).sort((a,b)=>b-a);
      const eliminados = [];
      for (const i of indices) {
        if (historial[i]) eliminados.push(historial.splice(i,1)[0]);
      }
      localStorage.setItem('historial_usuarios', JSON.stringify(historial));
      mostrarMensaje(`üóëÔ∏è Eliminados: ${eliminados.length}`);
      salirModoSeleccion();
      renderHistorial();
    } else if (pendienteEliminarIndex !== null) {
      ultimoEliminado = historial.splice(pendienteEliminarIndex, 1)[0];
      localStorage.setItem('historial_usuarios', JSON.stringify(historial));
      renderHistorial();
      mostrarMensaje(`üóëÔ∏è Eliminado: ${pendienteEliminarTitulo}`, true);
    }
    pendienteEliminarIndex = null;
    pendienteEliminarTitulo = null;
    document.getElementById('modal-confirmacion').style.display = 'none';
  };

  // ---------- Render con control de long-press ----------
  function renderHistorial() {
    const container = document.getElementById('historial-container');
    container.innerHTML = '';
    historial.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'item';
      if (seleccionados.has(index)) div.classList.add('selected');

      // contenido principal (evitar onclick directo en wrapper para controlar taps)
      div.innerHTML = `
        <div class="card-inner" style="text-decoration:none;color:inherit;">
          <div style="position: relative;">
            <img src="${item.imagen}" alt="${item.titulo}">
            <div class="capitulo">${item.progreso}</div>
            ${item.tipo ? `<div class="etiqueta">${item.tipo === 'serie' ? 'Serie' : 'Pel√≠cula'}</div>` : ''}
            <div class="select-overlay"><div class="check">‚úì</div></div>
          </div>
          <div class="item-title">${item.titulo}</div>
        </div>
        <button class="delete-btn hide-when-select" title="Eliminar" onclick="eliminarItem(${index}, '${(item.titulo||'').replace(/'/g, "\\'")}')">√ó</button>
      `;

      // eventos t√°ctiles y mouse (long press)
      // Touch events
      div.addEventListener('touchstart', (e) => {
        // inicio timer de long press
        if (longPressTimers.has(index)) clearTimeout(longPressTimers.get(index));
        const t = setTimeout(() => {
          // al activar long-press, entramos en modo selecci√≥n si no estamos
          if (!selectionMode) entrarModoSeleccion();
          toggleSeleccion(index);
        }, LONG_PRESS_DURATION);
        longPressTimers.set(index, t);
        div.classList.add('touching');
      }, {passive:true});

      div.addEventListener('touchend', (e) => {
        // si se solt√≥ antes del longpress -> comportamiento normal
        if (longPressTimers.has(index)) {
          clearTimeout(longPressTimers.get(index));
          longPressTimers.delete(index);
          // si estamos en modo selecci√≥n, un tap breve togglea selecci√≥n
          if (selectionMode) {
            toggleSeleccion(index);
          } else {
            // navegaci√≥n normal (solo si el target no fue el bot√≥n eliminar)
            // usamos verificarAcceso original
            verificarAcceso(item.archivo, item.adulto === true);
          }
        }
        div.classList.remove('touching');
      });

      div.addEventListener('touchmove', (e) => {
        // si se mueve el dedo cancelamos el longpress
        if (longPressTimers.has(index)) {
          clearTimeout(longPressTimers.get(index));
          longPressTimers.delete(index);
        }
        div.classList.remove('touching');
      }, {passive:true});

      // Mouse events (para probar en desktop)
      let mouseTimer = null;
      div.addEventListener('mousedown', (e) => {
        // evitar conflicto si clic en delete-btn
        if (e.target.closest('.delete-btn')) return;
        mouseTimer = setTimeout(() => {
          if (!selectionMode) entrarModoSeleccion();
          toggleSeleccion(index);
        }, LONG_PRESS_DURATION);
        div.classList.add('touching');
      });
      div.addEventListener('mouseup', (e) => {
        if (mouseTimer) {
          clearTimeout(mouseTimer);
          mouseTimer = null;
          if (selectionMode) {
            toggleSeleccion(index);
          } else {
            if (!e.target.closest('.delete-btn')) verificarAcceso(item.archivo, item.adulto === true);
          }
        }
        div.classList.remove('touching');
      });
      div.addEventListener('mouseleave', () => {
        if (mouseTimer) {
          clearTimeout(mouseTimer);
          mouseTimer = null;
        }
        div.classList.remove('touching');
      });

      container.appendChild(div);
    });
  }

  // llamada inicial
  renderHistorial();

  // Si quieres permitir cancelar modo selecci√≥n con back button o con toque fuera:
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && selectionMode) salirModoSeleccion();
  });

  // si el usuario toca en cualquier espacio vac√≠o fuera de tarjetas (en m√≥vil)
  document.addEventListener('click', (e) => {
    if (!selectionMode) return;
    // si el click no est√° dentro de una .item, salimos del modo selecci√≥n
    if (!e.target.closest('.item')) salirModoSeleccion();
  });

  // conservar tus funciones existentes (mostrarMensaje, eliminarItem, limpiarHistorial, verificarAcceso, modal edad)
  // Nota: eliminarItem ya est√° definida m√°s arriba en tu archivo original; si no, la incluimos:
  function eliminarItem(index, titulo) {
    pendienteEliminarIndex = index;
    pendienteEliminarTitulo = titulo;
    document.getElementById('modal-mensaje').textContent = `¬øEliminar "${titulo}" del historial?`;
    document.getElementById('modal-confirmacion').style.display = 'flex';
  }
</script>


  <!-- Modal flotante de edad -->
<div id="ageModal" class="age-modal hidden">
  <div class="age-modal-content">
    <span class="close-button" onclick="closeModal()">√ó</span>
    <h2>¬øEres mayor de edad?</h2>
    <label for="birthyear">A√±o de nacimiento:</label>
    <input type="number" id="birthyear" placeholder="A√±o" min="1900" max="2025" />
    <label for="age">Edad</label>
    <input type="number" id="age" placeholder="Edad" min="1" max="120" />
    <button id="confirmAgeBtn">Validar edad</button>
    <p id="result-message"></p>
  </div>
</div>

<style>
    .age-modal {
      position: fixed;
      z-index: 9999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4);
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .age-modal-content {
      background-color: #ffffff;
      color: #000000;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      width: 300px;
      position: relative;
      transition: background-color 0.3s ease, color 0.3s ease;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }


    .age-modal-content h2,
    .age-modal-content label,
    .age-modal-content p {
      color: #000000;
    }


    .age-modal-content input {
      width: 90%;
      margin: 10px auto;
      padding: 8px; 
      display: block; 
      background-color: #ffffff;  
      color: #000000;
      border: 1px solid #ccc; 
      border-radius: 5px;
    }


    .age-modal-content input::placeholder {
      color: #777;
    }

    /* Modo oscuro */

    body.dark .age-modal-content,
    .dark .age-modal-content {
      background-color: #1e1e1e;
      color: #f5f5f5;
    }

    body.dark .age-modal-content h2,
    .dark .age-modal-content h2,
    body.dark .age-modal-content label,
    .dark .age-modal-content label,
    body.dark .age-modal-content p,
    .dark .age-modal-content p {
      color: #f5f5f5;
    }

    body.dark .age-modal-content input,
    .dark .age-modal-content input {
      background-color: #2b2b2b;
      color: #ffffff;
      border: 1px solid #555;
    }

    body.dark .age-modal-content input::placeholder,
    .dark .age-modal-content input::placeholder {
      color: #ccc;
    }

    .age-modal-content button {
      background: #0b57cf;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }

    .age-modal-content button:hover {
      background: #063ea3;
    }

    .close-button {
      position: absolute;
      right: 12px;
      top: 8px;
      font-size: 20px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
    }

    .close-button:hover {
      color: #000;
    }

    body.dark .close-button {
      color: #aaa;
    }

    body.dark .close-button:hover {
      color: #fff;
    }

    .hidden {
      display: none;
    }
  </style>

<script>
let pendingRedirect = null;

function verificarAcceso(url, requiereEdad) {
  if (requiereEdad) {
    pendingRedirect = url;
    openModal();
  } else {
    location.assign(url);
  }
}

function openModal() {
  document.getElementById("ageModal").classList.remove("hidden");
  document.getElementById("result-message").innerText = "";
  document.getElementById("birthyear").value = "";
  document.getElementById("age").value = "";
}

function closeModal() {
  document.getElementById("ageModal").classList.add("hidden");
  pendingRedirect = null;
}

document.getElementById("confirmAgeBtn").addEventListener("click", function () {
  const birthYear = parseInt(document.getElementById("birthyear").value);
  const enteredAge = parseInt(document.getElementById("age").value);
  const currentYear = new Date().getFullYear();
  const calculatedAge = currentYear - birthYear;
  const result = document.getElementById("result-message");

  if (
    isNaN(birthYear) || isNaN(enteredAge) ||
    birthYear > currentYear || birthYear < 1900 ||
    enteredAge < 0 || enteredAge > 120
  ) {
    result.innerText = "Por favor completa los campos con valores v√°lidos.";
    result.style.color = "red";
    return;
  }

  if (enteredAge !== calculatedAge) {
    result.innerText = "La edad no coincide con el a√±o de nacimiento.";
    result.style.color = "red";
    return;
  }

  if (enteredAge >= 18) {
    result.innerText = "Acceso permitido. Redirigiendo...";
    result.style.color = "green";
    setTimeout(() => {
      if (pendingRedirect) {
        window.location.href = pendingRedirect;
      }
    }, 1500);
  } else {
    result.innerText = "No eres mayor de edad, vuelve a intentarlo m√°s adelante.";
    result.style.color = "red";
  }
});
</script>

</body>
</html>
