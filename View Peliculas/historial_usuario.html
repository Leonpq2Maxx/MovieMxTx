<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Historial</title>
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css">
<style>
/* ======== RESET ======== */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { margin:0; padding:0; background:#121212; color:#fff; font-family: Arial, sans-serif; }

/* ======== HEADER ======== */
header {
  background:#1e1e1e;
  padding:14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  font-size:1.2rem;
  position:sticky;
  top:0;
  z-index:50;
}
header i { cursor:pointer; font-size:1.4rem; }
#header-title.selection-active::after {
  content:" — Seleccionando";
  font-size:0.85rem;
  color:#00ffc3;
  margin-left:6px;
}

/* ======== GRID UNIVERSAL RESPONSIVE ======== */
#historial-container {
  display:grid;
  padding:12px;
  gap:12px;
}

/* EXTRA adaptable */
@media (min-width: 10px)  { #historial-container { grid-template-columns: repeat(2, 1fr); } }
@media (min-width: 420px) { #historial-container { grid-template-columns: repeat(2, 1fr); } }
@media (min-width: 600px) { #historial-container { grid-template-columns: repeat(3, 1fr); } }
@media (min-width: 768px) { #historial-container { grid-template-columns: repeat(4, 1fr); } }
@media (min-width: 1000px){ #historial-container { grid-template-columns: repeat(5, 1fr); } }
@media (min-width: 1300px){ #historial-container { grid-template-columns: repeat(6, 1fr); } }

/* ======== CARD ======== */
.item {
  background:#1a1a1a;
  border-radius:12px;
  overflow:hidden;
  position:relative;
  transition:transform 0.12s ease;
}
.item img {
  width:100%;
  aspect-ratio: 10/14;
  object-fit:cover;
}
.item-title {
  text-align:center;
  padding:8px;
  font-size:clamp(0.75rem, 2vw, 0.95rem);
  line-height:1.2rem;
}

/* ======== BADGES ======== */
.capitulo {
  position:absolute;
  bottom:10px;
  left:10px;
  background:rgba(0,0,0,0.7);
  color:#00ffae;
  padding:4px 7px;
  border-radius:6px;
  font-size:clamp(0.65rem, 1.8vw, 0.8rem);
}
.etiqueta {
  position:absolute;
  top:10px;
  left:10px;
  background:#e91e63;
  padding:4px 8px;
  border-radius:6px;
  font-size:clamp(0.6rem, 1.8vw, 0.75rem);
}

/* ======== DELETE BUTTON ======== */
.delete-btn {
  position:absolute;
  top:8px;
  right:8px;
  width:26px;
  height:26px;
  background:rgba(255,0,0,0.8);
  border:none;
  border-radius:50%;
  color:white;
  font-size:0.9rem;
  cursor:pointer;
  z-index:10;
}
.selection-mode .delete-btn { display:none; }

/* ======== MULTI-SELECT STYLE ======== */
.item.selected {
  outline:3px solid #00eaff;
  transform:scale(0.96);
}
.select-overlay {
  position:absolute;
  inset:8px;
  display:flex;
  justify-content:flex-end;
  pointer-events:none;
}
.check {
  display:none;
  background:rgba(0,0,0,0.6);
  padding:6px;
  color:#00ffae;
  border-radius:50%;
  margin:5px;
}
.item.selected .check { display:block; }

/* ======== MESSAGE FLOAT ======== */
#mensaje-confirmacion {
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.85);
  padding:12px 20px;
  border-radius:10px;
  display:none;
  font-size:1rem;
  z-index:9999;
  transition:opacity .4s ease;
}

/* ======== MODAL ======== */
#modal-confirmacion {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  backdrop-filter:blur(4px);
  z-index:99999;
  align-items:center;
  justify-content:center;
}
.modal-box {
  background:#1e1e1e;
  padding:20px;
  border-radius:14px;
  text-align:center;
  width:90%;
  max-width:350px;
}
.modal-btn {
  padding:10px 20px;
  border:none;
  border-radius:6px;
  margin:5px;
  font-size:1rem;
}
.modal-confirm { background:#e91e63; color:white; }
.modal-cancel { background:#333; color:white; }
</style>
</head>

<body>
<header>
  <i class="fas fa-arrow-left" onclick="history.back()"></i>
  <span id="header-title">Historial</span>
  <i id="trash-multi" class="fas fa-trash" style="display:none;" onclick="confirmarEliminarSeleccionados()"></i>
  <i id="trash-all" class="fas fa-trash-alt" onclick="limpiarHistorial()"></i>
  <i id="cancel-select" class="fas fa-times" style="display:none; margin-left:10px; font-size:1.3rem; cursor:pointer;" onclick="salirModoSeleccion()"></i>
</header>

<h2 style="padding:12px; font-size:1.1rem;">Vistos recientemente</h2>

<div id="historial-container"></div>

<div id="mensaje-confirmacion"></div>

<!-- MODAL -->
<div id="modal-confirmacion">
  <div class="modal-box">
    <p id="modal-mensaje"></p>
    <button class="modal-btn modal-confirm" onclick="confirmarEliminar()">Eliminar</button>
    <button class="modal-btn modal-cancel" onclick="cerrarModal()">Cancelar</button>
  </div>
</div>

<script>
/* STORAGE */
let historial = JSON.parse(localStorage.getItem("historial_usuarios") || "[]");
let seleccionados = new Set();
let seleccionMode = false;
let pendienteEliminar = null;
let longPressTimers = new Map();

/* MENSAJE */
function mostrarMensaje(msg){
  let box=document.getElementById("mensaje-confirmacion");
  box.textContent=msg;
  box.style.display="block";
  box.style.opacity="1";
  setTimeout(()=>{
    box.style.opacity="0";
    setTimeout(()=> box.style.display="none", 400);
  },1500);
}

/* RENDER */
function renderHistorial(){
  const cont=document.getElementById("historial-container");
  cont.innerHTML="";
  historial.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));

  historial.forEach((item,index)=>{
    let card=document.createElement("div");
    card.className="item";
    if(seleccionados.has(index)) card.classList.add("selected");

    card.innerHTML=`
      <div style='position:relative;'>
        <img src="${item.imagen}">
        <div class='capitulo'>${item.progreso}</div>
        <div class='etiqueta'>${item.tipo === "serie" ? "Serie" : "Película"}</div>
        <div class='select-overlay'><div class='check'>✓</div></div>
      </div>
      <div class='item-title'>${item.titulo}</div>
      <button class='delete-btn' onclick='eliminarItem(${index})'>×</button>
    `;

    /* LONG PRESS MOVIL */
    card.addEventListener("touchstart",()=>{
      const t=setTimeout(()=>{
        if(!seleccionMode) entrarModoSeleccion();
        toggleSeleccion(index);
      },550);
      longPressTimers.set(index,t);
    });
    card.addEventListener("touchend",()=>{
      if(longPressTimers.get(index)){
        clearTimeout(longPressTimers.get(index));
        longPressTimers.delete(index);
        if(seleccionMode) toggleSeleccion(index);
        else window.location.href=item.archivo;
      }
    });

    cont.appendChild(card);
  });
}

/* SELECCION */
function entrarModoSeleccion(){
  seleccionMode=true;
  document.body.classList.add("selection-mode");
  document.getElementById("trash-multi").style.display="inline-block";
  document.getElementById("trash-all").style.display="none";
  document.getElementById("header-title").classList.add("selection-active");
}
function salirModoSeleccion(){
  seleccionMode=false;
  seleccionados.clear();
  document.body.classList.remove("selection-mode");
  document.getElementById("trash-multi").style.display="none";
  document.getElementById("trash-all").style.display="inline-block";
  document.getElementById("header-title").classList.remove("selection-active");
  renderHistorial();

/* === Salir tocando fuera (opción B) === */
document.addEventListener('click', (e)=>{
  if(seleccionMode && !e.target.closest('.item') && !e.target.closest('#trash-multi') && !e.target.closest('#cancel-select')){
    salirModoSeleccion();
  }
});

/* === Botón atrás Android (opción E) === */
window.addEventListener('popstate', ()=>{
  if(seleccionMode){
    salirModoSeleccion();
    history.pushState(null, "");
  }
});

history.pushState(null, "");
}
function toggleSeleccion(i){
  if(seleccionados.has(i)) seleccionados.delete(i);
  else seleccionados.add(i);
  renderHistorial();
}

/* ELIMINAR */
function eliminarItem(i){
  pendienteEliminar={type:"one", index:i};
  document.getElementById("modal-mensaje").innerText=`¿Eliminar "${historial[i].titulo}"?`;
  abrirModal();
}
function confirmarEliminarSeleccionados(){
  if(seleccionados.size===0) return;
  pendienteEliminar={type:"multi", items:new Set(seleccionados)};
  document.getElementById("modal-mensaje").innerText=`Eliminar ${seleccionados.size} elementos?`;
  abrirModal();
}
function limpiarHistorial(){
  pendienteEliminar={type:"all"};
  document.getElementById("modal-mensaje").innerText="¿Eliminar TODO el historial?";
  abrirModal();
}

/* MODAL */
function abrirModal(){ document.getElementById("modal-confirmacion").style.display="flex"; }
function cerrarModal(){ document.getElementById("modal-confirmacion").style.display="none"; pendienteEliminar=null; }

function confirmarEliminar(){
  if(!pendienteEliminar) return;

  if(pendienteEliminar.type==="one") historial.splice(pendienteEliminar.index,1);
  if(pendienteEliminar.type==="multi"){
    const arr=Array.from(pendienteEliminar.items).sort((a,b)=>b-a);
    for(const i of arr) historial.splice(i,1);
    salirModoSeleccion();
  }
  if(pendienteEliminar.type==="all") historial=[];

  localStorage.setItem("historial_usuarios", JSON.stringify(historial));
  renderHistorial(); cerrarModal(); mostrarMensaje("Cambios aplicados.");
}

/* INIT */
renderHistorial();
</script>
</body>
</html>
